/*!
 * netrol.js v1.1.0-beta.1
 * Â© 2020-~ EuZen Chen
 * Released under the Anti 996 License
 */
var t=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t};var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};function r(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var n=function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t};var o=function(t){if(Array.isArray(t))return t};var s=function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var r=[],n=!0,o=!1,s=void 0;try{for(var i,a=t[Symbol.iterator]();!(n=(i=a.next()).done)&&(r.push(i.value),!e||r.length!==e);n=!0);}catch(t){o=!0,s=t}finally{try{n||null==a.return||a.return()}finally{if(o)throw s}}return r}};var i=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n};var a=function(t,e){if(t){if("string"==typeof t)return i(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(t,e):void 0}};var u=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var c=function(t,e){return o(t)||s(t,e)||a(t,e)||u()};var l,f,h,p=(function(t){function e(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=e=function(t){return typeof t}:t.exports=e=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(r)}t.exports=e}(f={path:l,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&f.path)}},f.exports),f.exports);function d(t){return null!==t&&"object"===p(t)}function v(t){return t&&t instanceof Function}function y(t){return FormData&&t instanceof FormData}function m(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function g(t,e){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0,o=new Error(t);return o.type=e,o.ErrorType={STOP:h.STOP,FAIL:h.FAIL,THROTTLE:h.THROTTLE,STATUS:h.STATUS,TIMEOUT:h.TIMEOUT,CANCELED:h.CANCELED},e===h.STATUS&&(o.statusCode=n.code),o.toJSON=function(){var e={type:this.type,message:t,ErrorType:this.ErrorType};return void 0!==this.statusCode&&(e.statusCode=this.statusCode),e},r?Promise.reject(o):o}!function(t){t[t.STOP=0]="STOP",t[t.FAIL=1]="FAIL",t[t.THROTTLE=2]="THROTTLE",t[t.STATUS=3]="STATUS",t[t.TIMEOUT=4]="TIMEOUT",t[t.CANCELED=5]="CANCELED"}(h||(h={}));var T=new(function(){function t(){e(this,t),this.targets={}}return n(t,[{key:"catch",value:function(t,e){if(t=Number(t),m(this.targets,t))throw g("The catcher of status code ".concat(t," already exists"),h.FAIL);this.targets[t]=e}},{key:"trigger",value:function(t){return t=Number(t),!!m(this.targets,t)&&(this.targets[t](),!0)}},{key:"registerTimeoutHander",value:function(t){this.timeoutHander=t}}]),t}());var b=new(function(){function t(){e(this,t),this.upload={},this.download={}}return n(t,[{key:"add",value:function(t,e,r){if(m(this[t],e))throw g("The listener ".concat(e," already exists"),h.FAIL);this[t][e]=r}},{key:"trigger",value:function(t,e,r){v(this[t][e])&&this[t][e](r)}},{key:"isExist",value:function(t,e){return!!m(this[t],e)}}]),t}());function O(t,e,r){var n,o="upload"===t?r.upload:r;function s(r){b.trigger(t,e,{type:t,event:r,status:n.START,statusText:"start",ProgressStatus:n})}function i(r){b.trigger(t,e,{type:t,event:r,status:n.PROGRESS,statusText:"progress",ProgressStatus:n,total:r.total,loaded:r.loaded})}function a(r){b.trigger(t,e,{type:t,event:r,status:n.CANCEL,statusText:"cancel",ProgressStatus:n})}function u(r){b.trigger(t,e,{type:t,event:r,status:n.FAIL,statusText:"fail",ProgressStatus:n})}function c(r){b.trigger(t,e,{type:t,event:r,status:n.SUCCESS,statusText:"success",ProgressStatus:n})}function l(r){b.trigger(t,e,{type:t,event:r,status:n.TIMEOUT,statusText:"timeout",ProgressStatus:n})}function f(){o.removeEventListener("loadstart",s),o.removeEventListener("progress",i),o.removeEventListener("abort",a),o.removeEventListener("error",u),o.removeEventListener("load",c),o.removeEventListener("timeout",l),o.removeEventListener("loadend",f),o=null}r=null,function(t){t[t.FAIL=0]="FAIL",t[t.SUCCESS=1]="SUCCESS",t[t.PROGRESS=2]="PROGRESS",t[t.START=3]="START",t[t.CANCEL=4]="CANCEL",t[t.TIMEOUT=5]="TIMEOUT"}(n||(n={})),o.addEventListener("loadstart",s),o.addEventListener("progress",i),o.addEventListener("abort",a),o.addEventListener("error",u),o.addEventListener("load",c),o.addEventListener("timeout",l),o.addEventListener("loadend",f)}var E=new(function(){function t(){e(this,t),this.xhrPools={}}return n(t,[{key:"isExist",value:function(t){return!!this.xhrPools[t]}},{key:"cancel",value:function(t){return!!this.xhrPools[t]&&(this.xhrPools[t].abort(),!0)}},{key:"add",value:function(t,e){this.xhrPools[t]||(this.xhrPools[t]=e)}},{key:"remove",value:function(t){this.xhrPools[t]&&delete this.xhrPools[t]}}]),t}()),S=function(){function t(r,n,o){e(this,t),this.xhr=null,this.resolve=null,this.reject=null,this.requestConfig=null,this.requestConfig=r,this.resolve=n,this.reject=o}return n(t,[{key:"start",value:function(t){var e=this.requestConfig.name;E.add(e,t),b.isExist("upload",e)&&O("upload",e,t),b.isExist("download",e)&&O("download",e,t),this.xhr=t}},{key:"success",value:function(){E.remove(this.requestConfig.name);var t=function(t){var e=t.responseType&&"text"!==t.responseType?t.response:t.responseText;if("string"==typeof e)try{e=JSON.parse(e)}catch(t){}return{body:e,xhr:t,status:t.status,statusText:t.statusText}}(this.xhr);if(t.status>=200&&t.status<300)return this.resolve(t);T.trigger(t.status)?this.reject(g("Not an error; promise stop; https status ".concat(t.status," be catched"),h.STOP)):this.reject(g("request failed with status code ".concat(t.status),h.STATUS,!1,{code:t.status}))}},{key:"timeout",value:function(){var t=this.requestConfig,e=t.name,r=t.method,n=t.url,o=t.timeout,s=t.data;E.remove(e),T.timeoutHander&&T.timeoutHander({apiName:e,method:r,url:n,timeout:o,data:s}),this.reject(g("timeout of ".concat(o," ms exceeded"),h.TIMEOUT))}},{key:"error",value:function(){E.remove(this.requestConfig.name),this.reject(g("Network Error",h.FAIL))}},{key:"abort",value:function(){E.remove(this.requestConfig.name),this.reject(g("Request cancelled",h.CANCELED))}}]),t}();function P(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function L(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?P(Object(n),!0).forEach((function(r){t(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var j={"Content-Type":"application/json;charset=utf-8",Accept:"application/json, text/plain, */*"};function w(t){return t.headers=L(L({},j),t.headers),E.isExist(t.name)?g("Not an error; Triggered throttle;",h.THROTTLE,!0):new Promise((function(e,r){var n=new S(t,(function(t){return e(t)}),(function(t){return r(t)}));!function(t,e){var r=t.headers,n=t.method,o=t.url,s=t.data,i=t.timeout,a=new XMLHttpRequest;a.open(n,o,!0),s&&y(s)&&delete r["Content-Type"],Object.entries(r).forEach((function(t){var e=c(t,2),r=e[0],n=e[1];a.setRequestHeader(r,n)})),a.timeout=i,a.onreadystatechange=function(){a&&a.readyState===XMLHttpRequest.DONE&&(0!==a.status||a.responseURL&&0===a.responseURL.indexOf("file:"))&&(e.success(),a=null)},a.ontimeout=function(){e.timeout(),a=null},a.onerror=function(){e.error(),a=null},a.onabort=function(){e.abort(),a=null},s||(s=null),e.start(a),a.send(s)}(t,n)}))}var x=new(function(){function t(){e(this,t),this.request=[],this.response=[]}return n(t,[{key:"req",value:function(t){this.request.push(t)}},{key:"res",value:function(t){this.response.push(t)}}]),t}());function A(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function C(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?A(Object(n),!0).forEach((function(r){t(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):A(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var k=function(){function t(r){e(this,t),this.apis={},this.parseOption(r)}return n(t,[{key:"parseOption",value:function(t,e,r){var n=this,o=t.apis,s=t.leach,i=t.module,a=t.config,u=void 0===a?{}:a,c=u.defaultMethod,l=u.baseUrl,f=u.timeout,p=u.headers;if(!o)throw g("apis is required in constructor",h.FAIL);Object.keys(o).forEach((function(t){var i=o[t],a=n.createApi(i,l||(null==r?void 0:r.baseUrl),c||(null==r?void 0:r.defaultMethod)||"get");a.headers=C(C({},null==r?void 0:r.headers),p),a.timeout=f||(null==r?void 0:r.timeout)||0,0===f&&(a.timeout=0),s&&s[t]&&(a.leach=s[t]),n.apis[e?"".concat(e,".").concat(t):t]=a})),i&&Object.keys(i).forEach((function(t){n.parseOption(i[t],t,u)}))}},{key:"createApi",value:function(t,e,r){return d(t)?{url:"".concat(e).concat(t.url),method:t.method.toLowerCase()}:{url:"".concat(e).concat(t),method:r.toLowerCase()}}},{key:"request",value:function(t,e){var r=this,n=this.apis[t];if(!n)return g("api ".concat(t," is not exist"),h.FAIL,!0);var o,s,i={name:t,data:e,headers:n.headers,method:n.method,url:n.url,timeout:n.timeout};i.data&&"get"===i.method&&(i.url=(o=i.url,s=e,o.includes("?")?Object.entries(s).forEach((function(t){var e=c(t,2),r=e[0],n=e[1];o+="&".concat(r,"=").concat(n)})):Object.entries(s).forEach((function(t,e){var r=c(t,2),n=r[0],s=r[1];o+=0===e?"?".concat(n,"=").concat(s):"&".concat(n,"=").concat(s)})),o),i.data=null);var a=[this.transformData,w];x.request.forEach((function(t){a.unshift(t)})),x.response.forEach((function(t){a.push((function(e){return t(e,r.stop)}))})),n.leach&&a.push((function(t){return n.leach(t,r.stop)}));for(var u=Promise.resolve(i);a.length;)u=u.then(a.shift());return u}},{key:"stop",value:function(){return g("Not an error; promise stop;",h.STOP,!0)}},{key:"transformData",value:function(t){var e,r=t.data;return"string"==typeof r||y(r)||(e=r,ArrayBuffer&&e instanceof ArrayBuffer)||function(t){return d(t)&&v(t.pipe)}(r)||function(t){return d(t)&&t instanceof File}(r)||function(t){return d(t)&&t instanceof Blob}(r)?Promise.resolve(t):d(r)?Promise.resolve(C(C({},t),{},{data:JSON.stringify(r)})):Promise.resolve(t)}}]),t}(),I=null;function q(t){return I?console.warn("netrol instance is only"):(I=new k(t),function(t,e){return I.request(t,e)})}var U={request:function(t){return x.req(t),this},response:function(t){return x.res(t),this}};function R(t,e){T.catch(t,e)}function D(t){if(T.timeoutHander)throw g("timeoutHander already exists",h.FAIL);T.registerTimeoutHander(t)}function N(t){return E.cancel(t)}var F={upload:function(t,e){b.add("upload",t,e)},download:function(t,e){b.add("download",t,e)}};export{N as cancel,q as create,U as interceptor,F as progressListener,D as timeoutHander,R as toCatch};
//# sourceMappingURL=netrol.esm.js.map
